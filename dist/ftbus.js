!function(e){var o={};function r(t){if(o[t])return o[t].exports;var n=o[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=o,r.d=function(e,o,t){r.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:t})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,o){if(1&o&&(e=r(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(r.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var n in e)r.d(t,n,function(o){return e[o]}.bind(null,n));return t},r.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(o,"a",o),o},r.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},r.p="",r(r.s=23)}([function(e,o){e.exports=require("koa-router")},function(e,o,r){const t=r(7);e.exports={parseArgs:()=>{const e=t(process.argv.slice(2));return(({config:e})=>!!e||(console.error("No config file specified, exemple: --config ./config/config.json"),!1))(e)?e:null}}},function(e,o){e.exports=require("fs")},function(e,o){e.exports=require("cron")},function(e,o){e.exports=require("net")},function(e,o){e.exports=require("jsmodbus")},function(e,o,r){const t=r(5),n=r(4),{CronJob:s}=r(3),i=r(2),c=r(1),a=new n.Socket,u=new t.client.TCP(a);a.on("connect",()=>{const e=c.parseArgs()||{},{configPath:o="./fTbus.config.json"}=e;if(!o.endsWith(".json"))return console.error("You must provide a json file for the configuration!"),!1;const r=JSON.parse(i.readFileSync(o,"utf8")),{scanModes:t}=r,n=JSON.parse(i.readFileSync(t,"utf8")),l=JSON.parse(i.readFileSync("./tests/optimizedConfig.json","utf8"));return l?n?(l.forEach(e=>{const{equipmentId:o,protocol:r,variableGroups:t}=e;Object.keys(t).forEach(e=>{const o=t[e],{frequence:r}=n.find(({name:o})=>o===e);new s({cronTime:r,onTick:()=>{Object.keys(o).forEach(e=>{const r=o[e],t=e=>{console.log("Response: ",JSON.stringify(e.response)),a.end()},n=e=>{console.error(e),a.end()};let s;switch(e){case"holdingRegister":s=((e,o)=>u.readHoldingRegisters(e,o).then(e=>t(e)).catch(e=>n(e)));break;case"inputRegister":s=((e,o)=>u.readInputRegisters(e,o).then(e=>t(e)).catch(e=>n(e)));break;case"discreteInput":s=((e,o)=>u.readDiscreteInputs(e,o).then(e=>t(e)).catch(e=>n(e)));break;default:s=((e,o)=>u.readCoils(e,o).then(e=>t(e)).catch(e=>n(e)))}Object.keys(r).forEach(e=>{r[e];const o=e.split("-"),t=parseInt(o[0],10),n=parseInt(o[1],10);s(t,n-t)})})},start:!1}).start()})}),!0):(console.info("Frequences file not found."),!1):(console.info("Optimized config file not found. Make sure you generated it correctly."),!1)}),e.exports=a},function(e,o){e.exports=require("minimist")},function(e,o,r){const t=r(2),n=r(1),s=(e,o,r)=>{const t=o.split("."),n=t.splice(0,1)[0];if(0!==t.length)return s(e[n],t.join("."),r);const i=e[n];return r&&delete e[n],i},i=(e,o)=>e.reduce((e,r)=>{const t=s(r,o,!0);return e[t]||(e[t]=[]),e[t].push(r),e},{});var c,a,u;e.exports=(()=>{const e=n.parseArgs()||{},{configPath:o="./fTbus.config.json"}=e;if(!o.endsWith(".json"))return console.error("You must provide a json file for the configuration!"),!1;const r=JSON.parse(t.readFileSync(o,"utf8")),{configExemple:l}=r,f=JSON.parse(t.readFileSync(l,"utf8"));if(!f)return console.error(`The file ${l} could not be loaded!`),!1;const d=f.map(e=>{const{equipmentId:o,protocol:r,variables:t}=e,n=i(t,"scanMode");return Object.keys(n).forEach(e=>{n[e]=i(n[e],`${r}.type`),Object.keys(n[e]).forEach(o=>{n[e][o]=(c=n[e][o],a=`${r}.address`,u=1e3,c.sort((e,o)=>{const r=s(e,a,!1),t=s(o,a,!1);return parseInt(r,16)-parseInt(t,16)}).reduce((e,o)=>{const r=s(o,a,!1),t=parseInt(r,16),n=`${16*Math.round(t/16)}-${16*Math.round((t+u)/16)}`;return e[n]||(e[n]=[]),e[n].push(o),e},{}))})}),{equipmentId:o,protocol:r,variableGroups:n}});return t.writeFile("./tests/optimizedConfig.json",JSON.stringify(d),"utf8",()=>{console.info("Optimized config file has been generated.")}),!0})},function(e,o){e.exports={getNode:function(e){const{query:o}=e.request,{node:r}=o,t=e.request.header.authorization||"";if(!t.startsWith("Basic "))throw new Error("The authorization header is either empty or isn't Basic.");{const e=t.split(" ")[1],o=Buffer.from(e,"base64").toString().split(":"),r=o[0],n=o[1];console.log(`request from ${r} with password:${n}`)}e.ok({node:r,query:o,comment:" node was requested!"})}}},function(e,o,r){const t=new(r(0)),n=r(9);t.get("/",n.getNode),e.exports=t.routes()},function(e,o){e.exports={getUser:function(e){const{query:o}=e.request,{user:r}=o;e.ok({user:r,query:o,comment:" user was requested!"})}}},function(e,o,r){const t=new(r(0)),n=r(11);t.get("/",n.getUser),e.exports=t.routes()},function(e,o,r){const t=r(12),n=r(10);e.exports=(e=>{e.prefix("/v1"),e.use("/users",t),e.use("/nodes",n)})},function(e,o){e.exports=require("koa-respond")},function(e,o){e.exports=require("koa-helmet")},function(e,o){e.exports=require("koa-bodyparser")},function(e,o,r){"use strict";e.exports=function(e){return e=Object.assign({},{allowMethods:"GET,HEAD,PUT,POST,DELETE,PATCH"},e),Array.isArray(e.exposeHeaders)&&(e.exposeHeaders=e.exposeHeaders.join(",")),Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),Array.isArray(e.allowHeaders)&&(e.allowHeaders=e.allowHeaders.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.credentials=!!e.credentials,e.keepHeadersOnError=void 0===e.keepHeadersOnError||!!e.keepHeadersOnError,function(o,r){const t=o.get("Origin");if(o.vary("Origin"),!t)return r();let n;if("function"==typeof e.origin){if(!(n=e.origin(o)))return r()}else n=e.origin||t;const s={};function i(e,r){o.set(e,r),s[e]=r}if("OPTIONS"!==o.method)return i("Access-Control-Allow-Origin",n),!0===e.credentials&&i("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&i("Access-Control-Expose-Headers",e.exposeHeaders),e.keepHeadersOnError?r().catch(e=>{throw e.headers=Object.assign({},e.headers,s),e}):r();{if(!o.get("Access-Control-Request-Method"))return r();o.set("Access-Control-Allow-Origin",n),!0===e.credentials&&o.set("Access-Control-Allow-Credentials","true"),e.maxAge&&o.set("Access-Control-Max-Age",e.maxAge),e.allowMethods&&o.set("Access-Control-Allow-Methods",e.allowMethods);let t=e.allowHeaders;t||(t=o.get("Access-Control-Request-Headers")),t&&o.set("Access-Control-Allow-Headers",t),o.status=204}}}},function(e,o){e.exports=require("koa-logger")},function(e,o){e.exports=require("koa-basic-auth")},function(e,o){e.exports=require("koa")},function(e,o,r){const t=r(20),n=r(0),s=r(19),i=(r(18),r(17)),c=r(16),a=r(15),u=r(14),l=new t,f=new n;l.use(a()),l.use(async(e,o)=>{try{await o()}catch(o){if(401!==o.status)throw o;e.status=401,e.set("WWW-Authenticate","Basic"),e.body="access was not authorized"}}),l.use(s({name:"jf",pass:"jfhjfh"})),l.use(i()),l.use(c({enableTypes:["json"],jsonLimit:"5mb",strict:!0,onerror(e,o){o.throw("body parse error",422)}})),l.use(u()),r(13)(f),l.use(f.routes()),l.use(f.allowedMethods()),e.exports=l},function(e,o){e.exports=require("dotenv")},function(e,o,r){r(22).config();const t=r(21),n=r(8),s=r(6);n();const i=process.env.PORT||3333;t.listen(i,()=>console.info(`API server started on ${i}`)),s.connect({host:"localhost",port:502})}]);