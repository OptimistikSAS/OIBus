!function(e){var t={};function o(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)o.d(r,s,function(t){return e[t]}.bind(null,s));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=25)}([function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=class{constructor(e){this.name=e,this.responses=new Map}update({id:e,data:t},o){this.responses.set(e,t),o(this.responses)}}},function(e,t,o){const r=o(1),s=(e,t,o)=>{const r=t.split("."),n=r.splice(0,1)[0];if(0!==r.length)return s(e[n],r.join("."),o);const c=e[n];return o&&delete e[n],c},n=(e,t,o={})=>e.reduce((e,r)=>{const n=s(r,t,!0);return e[n]||(e[n]=[]),e[n].push({...r,...o}),e},{}),c=(e,t,o)=>{return e.sort((e,o)=>{const r=s(e,t,!1),n=s(o,t,!1);return parseInt(r,16)-parseInt(n,16)}).reduce((e,r)=>{const n=s(r,t,!1),c=parseInt(n,16),i=16*Math.round(c/16),a=c<=i?i-16:i,u=16*Math.round((i+o)/16),l=((e,t)=>Object.keys(e).find(e=>{const o=e.split("-"),r=parseInt(o[0],10),s=parseInt(o[1],10);return t>=r&&t<=s}))(e,c)||`${a}-${u}`;return e[l]||(e[l]=[]),e[l].push(r),e},{})};e.exports=(e=>{const t=JSON.parse(r.readFileSync(e,"utf8"));return t?t.reduce((e,{equipmentId:t,protocol:o,variables:s})=>{const i=JSON.parse(r.readFileSync(`./tests/${o}.config.json`,"utf8")),{addressGap:a}=i;if("modbus"===o){const r=n(s,"scanMode",{equipmentId:t});Object.keys(r).forEach(e=>{r[e]=n(r[e],"equipmentId"),Object.keys(r[e]).forEach(t=>{r[e][t]=n(r[e][t],`${o}.type`),Object.keys(r[e][t]).forEach(s=>{r[e][t][s]=c(r[e][t][s],`${o}.address`,a)})})}),Object.keys(r).forEach(t=>{e[t]||(e[t]={}),e[t]={...e[t],...r[t]}})}return e},{}):(console.error(`The file ${e} could not be loaded!`),!1)})},function(e,t){e.exports=require("net")},function(e,t){e.exports=require("jsmodbus")},function(e,t,o){const r=o(5),s=o(4),n=o(3),c=o(2);e.exports=class{constructor(e){this.socket=new s.Socket,this.client=new r.client.TCP(this.socket),this.connected=!1,this.optimizedConfig=n(e),this.responses=new c("Modbus-responses")}poll(e){if(this.connected){const t=this.optimizedConfig[e];Object.keys(t).forEach(e=>{Object.keys(t[e]).forEach(o=>{const r=t[e][o],s=`read${`${o.charAt(0).toUpperCase()}${o.slice(1)}`}s`;Object.keys(r).forEach(e=>{const t=e.split("-"),o=parseInt(t[0],10),r=parseInt(t[1],10)-o;this.modbusFunction(s,{startAddress:o,rangeSize:r})})})})}else console.error("You must be connected to run pol.")}modbusFunction(e,{startAddress:t,rangeSize:o}){this.client[e](t,o).then(({response:e})=>{const r=`${t}-${t+o}:${new Date}`;this.responses.update({id:r,data:e},e=>console.log(e))}).catch(e=>{console.error(e),this.disconnect()})}connect(e){this.socket.connect({host:e,port:502}),this.connected=!0}disconnect(){this.socket.end(),this.connected=!1}}},function(e,t){e.exports=require("minimist")},function(e,t,o){const r=o(7),s=o(1);e.exports={parseArgs:()=>{const e=r(process.argv.slice(2));return(({config:e="./fTbus.config.json"})=>!!e||(console.error("No config file specified, exemple: --config ./config/config.json"),!1))(e)?e:null},tryReadFile:e=>{try{return JSON.parse(s.readFileSync(e,"utf8"))}catch(e){return console.error(e),e}}}},function(e,t){e.exports=require("cron")},function(e,t,o){const{CronJob:r}=o(9),{parseArgs:s,tryReadFile:n}=o(8),c=o(6);e.exports={start:(e=(()=>{}))=>{const t=s()||{},{configPath:o="./fTbus.config.json"}=t;o.endsWith(".json")||console.error("You must provide a json file for the configuration!");const i=n(o),{scanModes:a,config:u}=i,l=n(a),d=new c(u);l?(d.connect("localhost"),l.forEach(({name:e,cronTime:t})=>{new r({cronTime:t,onTick:()=>d.poll(e),start:!1}).start()})):console.error("Frequences file not found."),e()}}},function(e,t){e.exports={getNode:function(e){const{query:t}=e.request,{node:o}=t,r=e.request.header.authorization||"";if(!r.startsWith("Basic "))throw new Error("The authorization header is either empty or isn't Basic.");{const e=r.split(" ")[1],t=Buffer.from(e,"base64").toString().split(":"),o=t[0],s=t[1];console.log(`request from ${o} with password:${s}`)}e.ok({node:o,query:t,comment:" node was requested!"})}}},function(e,t,o){const r=new(o(0)),s=o(11);r.get("/",s.getNode),e.exports=r.routes()},function(e,t){e.exports={getUser:function(e){const{query:t}=e.request,{user:o}=t;e.ok({user:o,query:t,comment:" user was requested!"})}}},function(e,t,o){const r=new(o(0)),s=o(13);r.get("/",s.getUser),e.exports=r.routes()},function(e,t,o){const r=o(14),s=o(12);e.exports=(e=>{e.prefix("/v1"),e.use("/users",r),e.use("/nodes",s)})},function(e,t){e.exports=require("koa-respond")},function(e,t){e.exports=require("koa-helmet")},function(e,t){e.exports=require("koa-bodyparser")},function(e,t,o){"use strict";e.exports=function(e){return e=Object.assign({},{allowMethods:"GET,HEAD,PUT,POST,DELETE,PATCH"},e),Array.isArray(e.exposeHeaders)&&(e.exposeHeaders=e.exposeHeaders.join(",")),Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),Array.isArray(e.allowHeaders)&&(e.allowHeaders=e.allowHeaders.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.credentials=!!e.credentials,e.keepHeadersOnError=void 0===e.keepHeadersOnError||!!e.keepHeadersOnError,function(t,o){const r=t.get("Origin");if(t.vary("Origin"),!r)return o();let s;if("function"==typeof e.origin){if(!(s=e.origin(t)))return o()}else s=e.origin||r;const n={};function c(e,o){t.set(e,o),n[e]=o}if("OPTIONS"!==t.method)return c("Access-Control-Allow-Origin",s),!0===e.credentials&&c("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&c("Access-Control-Expose-Headers",e.exposeHeaders),e.keepHeadersOnError?o().catch(e=>{throw e.headers=Object.assign({},e.headers,n),e}):o();{if(!t.get("Access-Control-Request-Method"))return o();t.set("Access-Control-Allow-Origin",s),!0===e.credentials&&t.set("Access-Control-Allow-Credentials","true"),e.maxAge&&t.set("Access-Control-Max-Age",e.maxAge),e.allowMethods&&t.set("Access-Control-Allow-Methods",e.allowMethods);let r=e.allowHeaders;r||(r=t.get("Access-Control-Request-Headers")),r&&t.set("Access-Control-Allow-Headers",r),t.status=204}}}},function(e,t){e.exports=require("koa-logger")},function(e,t){e.exports=require("koa-basic-auth")},function(e,t){e.exports=require("koa")},function(e,t,o){const r=o(22),s=o(0),n=o(21),c=(o(20),o(19)),i=o(18),a=o(17),u=o(16),l=new r,d=new s;l.use(a()),l.use(async(e,t)=>{try{await t()}catch(t){if(401!==t.status)throw t;e.status=401,e.set("WWW-Authenticate","Basic"),e.body="access was not authorized"}}),l.use(n({name:"jf",pass:"jfhjfh"})),l.use(c()),l.use(i({enableTypes:["json"],jsonLimit:"5mb",strict:!0,onerror(e,t){t.throw("body parse error",422)}})),l.use(u()),o(15)(d),l.use(d.routes()),l.use(d.allowedMethods()),e.exports=l},function(e,t){e.exports=require("dotenv")},function(e,t,o){o(24).config();const r=o(23);o(10).start(()=>console.info("Engine started."));const s=process.env.PORT||3333;r.listen(s,()=>console.info(`API server started on ${s}`))}]);