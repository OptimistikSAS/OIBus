!function(e){var t={};function o(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)o.d(n,s,function(t){return e[t]}.bind(null,s));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=5)}([function(e,t){e.exports=class{constructor(e){this.engine=e,this.equipments={}}}},function(e,t){e.exports=require("sprintf-js")},function(e,t,o){const n=o(6),s=o(3),r=o(7);e.exports={parseArgs:()=>{const e=n(process.argv.slice(2));return(({config:e="./fTbus.config.json"})=>!!e||(console.error("No config file specified, example: --config ./config/config.json"),!1))(e)?e:null},tryReadFile:e=>{if(!e.endsWith(".json"))return console.error("You must provide a json file for the configuration!"),new Error("You must provide a json file for the configuration!");try{return r.parse(s.readFileSync(e,"utf8"))}catch(e){return console.error(e),e}}}},function(e,t){e.exports=require("fs")},function(e,t,o){const n=o(20);e.exports=class{constructor(e,t){this.queue=new n(e),this.applicationParameters=t}connect(){console.info("connect",this.queue.length)}disconnect(){console.info("disconnect",this.queue.length)}onScan(){console.info("onScan",this.queue.length)}}},function(e,t,o){const{parseArgs:n}=o(2),s=o(8),r=o(23),i=n()||{},{config:c="./fTbus.json"}=i;global.fTbusConfig=s.loadConfig(c);const{debug:a=!1,port:u=3333}=global.fTbusConfig,l=o(33).version,p=new s,d=new r(a);a&&console.info("Mode Debug enabled"),console.info(`fTbus version ${l}`),d.listen(u,()=>console.info(`Server started on ${u}`)),p.start(global.fTbusConfig,()=>console.info("Engine started."))},function(e,t){e.exports=require("minimist")},function(e,t){e.exports=require("json5")},function(e,t,o){const{CronJob:n}=o(9),{tryReadFile:s}=o(2),r={Modbus:o(10),OPCUA:o(14),CSV:o(17)},i={Console:o(19),InfluxDB:o(21)},c={},a={};e.exports=class{constructor(){this.queues=[]}addValue({data:e,dataId:t,pointId:o,timestamp:n}){this.queues.forEach(s=>{s.enqueue({data:e,dataId:t,pointId:o,timestamp:n})}),Object.values(a).forEach(e=>e.onUpdate())}registerQueue(e){this.queues.push(e)}start(e,t){Object.values(e.equipments).forEach(t=>{const{protocol:o}=t;!c[o]&&e.south[o.toLowerCase()].enabled&&(r[o]?(c[o]=new r[o](e,this),c[o].connect()):console.error("This protocol is not supported : ",o))}),Object.values(e.north).forEach(e=>{const{type:t}=e;e.enabled&&(i[t]?(a[t]=new i[t](this,e),a[t].connect()):console.error("This application is not supported : ",t))}),e.engine.scanModes.forEach(({scanMode:e,cronTime:t})=>{new n({cronTime:t,onTick:()=>{Object.values(c).forEach(t=>t.onScan(e))},start:!1}).start()}),t&&t()}static loadConfig(e){const t=s(e);if(!t.engine.scanModes)throw console.error("You should define scan modes."),new Error("You should define scan modes.");if(!t.equipments)throw console.error("You should define equipments."),new Error("You should define equipments.");if(!t.engine.types)throw console.error("You should define types."),new Error("You should define types.");if(!t.north)throw console.error("You should define application parameters."),new Error("You should define application parameters.");if(!t.south)throw console.error("You should define protocol parameters."),new Error("You should define protocol parameters.");return t.equipments.forEach(e=>{e.points.forEach(t=>{"."===t.pointId.charAt(0)&&(t.pointId=e.pointIdRoot+t.pointId.slice(1)),t.scanMode||(t.scanMode=e.defaultScanMode)})}),t}}},function(e,t){e.exports=require("cron")},function(e,t,o){const n=o(11),s=o(12),r=o(13),i=o(0),c=(e,t)=>{t[e.equipmentId]={socket:new s.Socket,host:e.Modbus.host,port:e.Modbus.port,connected:!1},t[e.equipmentId].client=new n.client.TCP(t[e.equipmentId].socket)},a=e=>{global.fTbusConfig.engine.types.forEach(t=>{t.type===e.pointId.split(".").slice(-1).pop()&&(e.type=t.fields[0].type,e.dataId=t.fields[0].name,t.fields.length>1&&console.error("Modbus points cannot contain more than 1 field"))})};e.exports=class extends i{constructor({equipments:e,south:t},o){super(o),this.optimizedConfig=r(e,t.modbus.addressGap),e.forEach(e=>{e.Modbus&&c(e,this.equipments)})}onScan(e){const t=this.optimizedConfig[e];Object.keys(t).forEach(e=>{this.equipments[e].connected&&Object.keys(t[e]).forEach(o=>{const n=t[e][o],s=`read${`${o.charAt(0).toUpperCase()}${o.slice(1)}`}s`;Object.entries(n).forEach(([t,o])=>{o.forEach(e=>a(e));const n=t.split("-"),r=parseInt(n[0],10),i=parseInt(n[1],10)-r;this.modbusFunction(s,{startAddress:r,rangeSize:i},e,o)})})})}modbusFunction(e,{startAddress:t,rangeSize:o},n,s){this.equipments[n].client[e](t,o).then(({response:e})=>{const o=`${new Date}`;s.forEach(n=>{const s=parseInt(n.Modbus.address,16)-t-1;let r=e.body.valuesAsArray[s];switch(n.type){case"boolean":r=!!r;break;case"number":break;default:console.error("This point type was not recognized : ",n.type)}const i={pointId:n.pointId,timestamp:o,dataId:n.dataId,data:r};this.engine.addValue(i)})}).catch(e=>{console.error(e)})}connect(){Object.values(this.equipments).forEach(e=>{const{host:t,port:o}=e;e.socket.connect({host:t,port:o},()=>{e.connected=!0}),e.socket.on("error",e=>{console.error(e)})})}disconnect(){Object.values(this.equipments).forEach(e=>{e.connected&&(e.socket.end(),e.connected=!1)})}}},function(e,t){e.exports=require("jsmodbus")},function(e,t){e.exports=require("net")},function(e,t){const o=(e,t,n)=>{const s=t.split("."),r=s.splice(0,1)[0];if(0!==s.length)return o(e[r],s.join("."),n);const i=e[r];return n&&delete e[r],i},n=(e,t,n={})=>e.reduce((e,s)=>{const r=o(s,t,!0);return e[r]||(e[r]=[]),e[r].push({...s,...n}),e},{}),s=(e,t,n)=>{return e.sort((e,n)=>{const s=o(e,t,!1),r=o(n,t,!1);return parseInt(s,16)-parseInt(r,16)}).reduce((e,s)=>{const r=o(s,t,!1),i=parseInt(r,16),c=16*Math.round(i/16),a=i<=c?c-16:c,u=16*Math.round((c+n)/16),l=((e,t)=>Object.keys(e).find(e=>{const o=e.split("-"),n=parseInt(o[0],10),s=parseInt(o[1],10);return t>=n&&t<=s}))(e,i)||`${a}-${u}`;return e[l]||(e[l]=[]),e[l].push(s),e},{})};e.exports=((e,t)=>{return e.reduce((e,{equipmentId:o,protocol:r,points:i})=>{if("Modbus"===r){const c=n(i,"scanMode",{equipmentId:o});Object.keys(c).forEach(e=>{c[e]=n(c[e],"equipmentId"),Object.keys(c[e]).forEach(o=>{c[e][o]=n(c[e][o],`${r}.type`),Object.keys(c[e][o]).forEach(n=>{c[e][o][n]=s(c[e][o][n],`${r}.address`,t[n])})})}),Object.keys(c).forEach(t=>{e[t]||(e[t]={}),e[t]={...e[t],...c[t]}})}return e},{})})},function(e,t,o){const n=o(15),{sprintf:s}=o(1),r=o(0),i=o(16),c=(e,t,o)=>{o[t.equipmentId]={client:new n.OPCUAClient({endpoint_must_exist:!1}),url:s(e.connectionAddress.opc,t.OPCUA)}};e.exports=class extends r{constructor({equipments:e,south:t},o){super(o),this.optimizedConfig=i(e),e.forEach(e=>{e.OPCUA&&c(t.opcua,e,this.equipments)})}async connect(){await Object.values(this.equipments).forEach(async e=>{await e.client.connect(e.url),await e.client.createSession((t,o)=>{t||(e.session=o,e.connected=!0)})})}async onScan(e){const t=this.optimizedConfig[e];Object.keys(t).forEach(e=>{if(this.equipments[e].connected){const o={},n=10;t[e].forEach(e=>{console.log(e),o[e.pointId]={nodeId:s("ns=%(ns)s;s=%(s)s",e.OPCUAnodeId)}}),this.equipments[e].session.read(Object.values(o),n,(e,t)=>{e||Object.keys(o).length!==t.length||(console.log(o),Object.keys(o).forEach(e=>{const o=t.shift(),n={pointId:e,timestamp:o.sourceTimestamp.toString()},s=typeFromPointId(e);global.fTbusConfig.engine.types.forEach(e=>{s===e.type&&e.fields.forEach(e=>{n[e.name]=o.value[e.name]})}),this.engine.addValue(n)}))})}})}}},function(e,t){e.exports=require("node-opcua")},function(e,t){const o=(e,t,n)=>{const s=t.split("."),r=s.splice(0,1)[0];if(0!==s.length)return o(e[r],s.join("."),n);const i=e[r];return n&&delete e[r],i},n=(e,t,n={})=>e.reduce((e,s)=>{const r=o(s,t,!0);return e[r]||(e[r]=[]),e[r].push({...s,...n}),e},{});e.exports=(e=>{return e.reduce((e,{equipmentId:t,protocol:o,points:s})=>{if("OPCUA"===o){const o=n(s,"scanMode",{equipmentId:t});Object.keys(o).forEach(e=>{o[e]=n(o[e],"equipmentId"),Object.values(o[e]).forEach(e=>{e.forEach(e=>{delete e.type})})}),Object.keys(o).forEach(t=>{e[t]||(e[t]={}),e[t]={...e[t],...o[t]}})}return e},{})})},function(e,t,o){const n=o(3),s=o(18),r=o(0),i=(e,t)=>{const o=n.readFileSync(e).toString();return console.log("content :",o),s.toArrays(o,{separator:t})};e.exports=class extends r{constructor({equipments:e},t){super(t),this.equipments=e,this.startWord="CSV connected."}connect(){console.log(this.startWord)}onScan(){this.equipments.forEach(e=>{const{points:t}=e,{inputFolder:o,separator:s,archiveFolder:r,errorFolder:c}=e.CSV;n.readdir(o,(a,u)=>{a||(u.length||console.log("The folder ",o," is empty."),u.forEach(a=>{console.log("Opening the file ",a);const u=i(`${o}${a}`,s);if(e.hasFirstLine){const o="number"==typeof e.CSV.indexOfTimeStamp?e.CSV.indexOfTimeStamp:u[0].indexOf(e.CSV.indexOfTimeStamp);t.forEach(e=>{const t="number"==typeof e.CSV.column?e.CSV.column:u[0].indexOf(e.CSV.column);u.forEach((n,s)=>{if(0!==s){const s=n[t],r=n[o];this.engine.addValue({pointId:e.pointId,timestamp:r,data:s})}})})}else{const{indexOfTimeStamp:o}=e.CSV;t.forEach(e=>{const{column:t}=e.CSV;u.forEach(n=>{const s=n[t],r=n[o];this.engine.addValue({pointId:e.pointId,timestamp:r,data:s})})})}n.rename(`${o}${a}`,`${r}fichier.csv`,e=>{if(e)return n.writeFile(`${c}error.txt`,e.toString()),void console.log(e);console.log("Rename complete!")})}))})})}}},function(e,t){e.exports=require("javascript-csv")},function(e,t,o){const{sprintf:n}=o(1),s=o(4);e.exports=class extends s{onUpdate(){console.log(this.queue.flush())}showAndDelete(){this.queue.length>0&&console.log(n(this.applicationParameters.Console.content,this.queue.dequeue())),console.log(this.queue.buffer)}}},function(e,t){e.exports=class{constructor(e){this.buffer=[],e.registerQueue(this)}enqueue(e){this.buffer.push(e)}dequeue(){return this.buffer.shift()}flush(e=(()=>{})){const t=[];for(;this.length;)t.push(this.dequeue()),e(t.slice(-1)[0]);return t}get length(){return this.buffer.length}}},function(e,t,o){const n=o(22),{sprintf:s}=o(1),r=o(4),i=(e,t)=>{t.slice(1).split("/").forEach(t=>{const o=t.replace(/[\w ]+\.([\w]+)/g,"$1"),n=t.replace(/([\w ]+)\.[\w]+/g,"$1");e[o]=n})};e.exports=class extends r{constructor(e,t){super(e,t),this.host=t.InfluxDB.host,this.currentObject={}}onUpdate(){this.queue.flush(e=>this.makeRequest(e))}makeRequest(e){const{pointId:t}=e;console.log(e);const o={host:this.host};Object.entries(e).forEach(([e,t])=>{"pointId"!==e&&(o[e]=t)}),i(o,t),console.log(o.dataId),Object.entries(o).forEach(([e,t])=>{e!==o.dataId&&(console.log(t,e),o[e]=t.replace(/ /g,"\\ "),Number.isNaN(parseInt(t,10))||(o.measurement=e))});const r=this.applicationParameters.InfluxDB.insert.replace(/'/g,"");let c=`${r.split(" ")[2]} ${r.split(" ")[3]}`.replace(/zzz/g,"%(measurement)s").replace(/ \w+=.*/g," %(dataId)s=");c=`${c}%(${o.dataId})s`,Object.keys(o).forEach(e=>{["data","host","measurement",o.measurement,"base"].includes(e)||(c=c.replace(/([a-z])\1\1(tag)?=%\(\1\1\1\)/,`${e}=%(${e})`))}),c=c.replace(/,([a-z])\1\1(tag)?=%\(\1\1\1\)/g,""),c=s(c,o),n(s(`http://${r.split(" ")[0]}`,o),{body:c,headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST"})}}},function(e,t){e.exports=require("node-fetch")},function(e,t,o){const n=o(24),s=o(25),r=o(26),i=o(27),c=o(28),a=o(29),u=o(30),l=o(31),p=o(32);e.exports=class{constructor(e){this.app=new n;const t=new s;this.debug=e,"debug"===this.debug&&this.app.use(i()),this.app.use(u()),this.app.use(async(e,t)=>{try{await t()}catch(t){if(401!==t.status)throw t;e.status=401,e.set("WWW-Authenticate","Basic"),e.body="access was not authorized"}}),this.app.use(r({name:"admin",pass:"admin"})),this.app.use(c()),this.app.use(a({enableTypes:["json"],jsonLimit:"5mb",strict:!0,onerror(e,t){t.throw("body parse error",422)}})),this.app.use(l()),t.prefix("/v0"),t.get("/",(e,t)=>{e.ok({comment:" fTbus"})}).get("/infos",p.getInfo),this.app.use(t.routes()),this.app.use(t.allowedMethods())}listen(e,t){this.app.listen(e,t)}}},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("koa-basic-auth")},function(e,t){e.exports=require("koa-logger")},function(e,t,o){"use strict";e.exports=function(e){return e=Object.assign({},{allowMethods:"GET,HEAD,PUT,POST,DELETE,PATCH"},e),Array.isArray(e.exposeHeaders)&&(e.exposeHeaders=e.exposeHeaders.join(",")),Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),Array.isArray(e.allowHeaders)&&(e.allowHeaders=e.allowHeaders.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.credentials=!!e.credentials,e.keepHeadersOnError=void 0===e.keepHeadersOnError||!!e.keepHeadersOnError,function(t,o){const n=t.get("Origin");if(t.vary("Origin"),!n)return o();let s;if("function"==typeof e.origin){if(!(s=e.origin(t)))return o()}else s=e.origin||n;const r={};function i(e,o){t.set(e,o),r[e]=o}if("OPTIONS"!==t.method)return i("Access-Control-Allow-Origin",s),!0===e.credentials&&i("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&i("Access-Control-Expose-Headers",e.exposeHeaders),e.keepHeadersOnError?o().catch(e=>{throw e.headers=Object.assign({},e.headers,r),e}):o();{if(!t.get("Access-Control-Request-Method"))return o();t.set("Access-Control-Allow-Origin",s),!0===e.credentials&&t.set("Access-Control-Allow-Credentials","true"),e.maxAge&&t.set("Access-Control-Max-Age",e.maxAge),e.allowMethods&&t.set("Access-Control-Allow-Methods",e.allowMethods);let n=e.allowHeaders;n||(n=t.get("Access-Control-Request-Headers")),n&&t.set("Access-Control-Allow-Headers",n),t.status=204}}}},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("koa-helmet")},function(e,t){e.exports=require("koa-respond")},function(e,t){e.exports={getInfo:e=>{const{query:t}=e.request,o=e.request.header.authorization||"";if(o.startsWith("Basic ")){{const e=o.split(" ")[1],t=Buffer.from(e,"base64").toString().split(":"),n=t[0],s=t[1];console.log(`request from ${n} with password:${s}`)}e.ok({query:t,config:global.fTbusConfig})}else e.throw(400,"The authorization header is either empty or is not Basic.")}}},function(e){e.exports={name:"ftbus",private:!0,version:"0.0.1",main:"index.js",author:"factoryThings",license:"SEE LICENSE in LICENSE",scripts:{start:"node src/index.js --config ./tests/fTbus.json",build:"npx webpack --mode production","build-dev":"npx webpack --mode development","build-doc":"esdoc",test:"jest",lint:"eslint ."},keywords:["factoryThings"],dependencies:{"@babel/runtime":"^7.1.2","@koa/cors":"^2.2.2",async:"^2.6.1",cron:"^1.4.1",dotenv:"^6.0.0",express:"^4.16.3","javascript-csv":"^1.0.7",jsmodbus:"^3.1.0",json5:"^2.1.0",koa:"^2.5.3","koa-basic-auth":"^3.0.0","koa-bodyparser":"^4.2.1","koa-helmet":"^4.0.0","koa-logger":"^3.2.0","koa-respond":"^2.1.0","koa-router":"^7.4.0",minimist:"^1.2.0","node-fetch":"^2.2.0","node-opcua":"^0.4.5","sprintf-js":"^1.1.1"},devDependencies:{"@babel/core":"^7.1.2","@babel/preset-env":"^7.1.0","babel-eslint":"^10.0.1","babel-loader":"^8.0.4",eslint:"^5.6.1","eslint-config-airbnb":"^17.1.0","eslint-plugin-import":"^2.14.0","eslint-plugin-jsx-a11y":"^6.1.1","eslint-plugin-react":"^7.11.1","ignore-loader":"^0.1.2",webpack:"^4.20.2","webpack-cli":"^3.1.2"}}}]);