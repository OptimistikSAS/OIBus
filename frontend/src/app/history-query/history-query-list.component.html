<div class="oib-padded-container">
  <div class="d-flex justify-content-between">
    <div class="oib-title-container mb-3">
      <div class="oib-block-title">
        <img class="oib-title-image pt-2" src="/home/history-query.svg" />
      </div>
      <h1 class="oib-title">
        <span translate="history-query.list"></span>
        <span class="ms-4">
          <button class="btn btn-primary" id="create-history-query-button" (click)="createHistoryQuery()">
            <span class="fa fa-plus"></span>
          </button>
        </span>
      </h1>
    </div>
  </div>

  <form class="px-3 mb-4 d-none d-lg-block oib-search-form" id="search-form" [formGroup]="searchForm">
    <div class="row gx-2 py-3">
      <label class="col-auto col-form-label"><i class="fa fa-search fa-lg"></i></label>
      <label for="name" class="col-auto col-form-label" translate="history-query.search-by-name"></label>
      <div class="col-2">
        <input type="text" class="form-control" id="name" formControlName="name" />
      </div>
    </div>
  </form>

  <div class="justify-content-between d-flex">
    <oib-legend *ngIf="this.allHistoryQueries && this.allHistoryQueries.length > 0" [legendList]="LEGEND"></oib-legend>
    <!-- only display it if there is more than 1 page -->
    <oib-pagination
      *ngIf="displayedHistoryQueries.totalPages > 1"
      class="d-flex justify-content-end"
      [page]="displayedHistoryQueries"
      (pageChanged)="changePage($event)"
    ></oib-pagination>
  </div>

  <!-- the loading spinner when queries are not yet loaded -->
  <oib-loading-spinner *ngIf="!allHistoryQueries"></oib-loading-spinner>

  <!-- the list of queries or a caption if empty -->
  <ng-container *ngIf="allHistoryQueries">
    <div *ngIf="displayedHistoryQueries.content.length !== 0; else empty">
      <table class="mt-2 table table-sm table-hover oib-table">
        <thead>
          <tr>
            <th></th>
            <th translate="history-query.name"></th>
            <th translate="history-query.interval" style="width: 22rem"></th>
            <th translate="history-query.description"></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let query of displayedHistoryQueries.content">
            <td>
              <div [class]="getStatusClass(query.status)"></div>
            </td>
            <td>{{ query.name }}</td>
            <td>
              <div>
                {{ query.startTime | datetime:'ff' }}
                <div class="fa fa-arrow-right oib-fa-arrow"></div>
                {{ query.endTime | datetime:'ff' }}
              </div>
            </td>
            <td>{{ query.description }}</td>
            <td class="text-nowrap action-buttons">
              <div class="pull-right">
                <button
                  *ngIf="query.status === 'PENDING'"
                  class="btn btn-link py-0 px-1 m-0"
                  id="history-query-start"
                  (click)="toggleHistoryQuery(query, 'RUNNING')"
                  [disabled]="states.get(query.id)?.isPending | async"
                >
                  <span class="fa fa-spinner fa-spin" role="status" *ngIf="states.get(query.id)?.isPending | async"></span>
                  <span class="fa fa-play" role="status" *ngIf="(states.get(query.id)?.isPending | async) === false"></span>
                </button>
                <button
                  *ngIf="query.status === 'RUNNING'"
                  class="btn btn-link py-0 px-1 m-0"
                  id="history-query-pause"
                  (click)="toggleHistoryQuery(query, 'PAUSED')"
                  [disabled]="states.get(query.id)?.isPending | async"
                >
                  <span class="fa fa-spinner fa-spin" role="status" *ngIf="states.get(query.id)?.isPending | async"></span>
                  <span class="fa fa-pause" role="status" *ngIf="(states.get(query.id)?.isPending | async) === false"></span>
                </button>
                <button
                  *ngIf="query.status === 'PAUSED'"
                  class="btn btn-link py-0 px-1 m-0"
                  id="history-query-unpause"
                  (click)="toggleHistoryQuery(query, 'RUNNING')"
                  [disabled]="states.get(query.id)?.isPending | async"
                >
                  <span class="fa fa-spinner fa-spin" role="status" *ngIf="states.get(query.id)?.isPending | async"></span>
                  <span class="fa fa-play" role="status" *ngIf="(states.get(query.id)?.isPending | async) === false"></span>
                </button>
                <button
                  *ngIf="query.status === 'FINISHED' || query.status === 'ERRORED'"
                  class="btn btn-link py-0 px-1 m-0"
                  id="history-query-restart"
                  (click)="toggleHistoryQuery(query, 'RUNNING')"
                  [disabled]="states.get(query.id)?.isPending | async"
                >
                  <span class="fa fa-spinner fa-spin" role="status" *ngIf="states.get(query.id)?.isPending | async"></span>
                  <span class="fa fa-repeat" role="status" *ngIf="(states.get(query.id)?.isPending | async) === false"></span>
                </button>
                <!-- Display button -->
                <a class="btn btn-link display-history-query px-1 py-0" id="display-link" [routerLink]="[query.id]">
                  <span class="fa fa-search"></span>
                </a>
                <!-- Edit button -->
                <a class="btn btn-link edit-history-query px-1 py-0" id="edit-link" [routerLink]="[query.id, 'edit']">
                  <span class="fa fa-pencil"></span>
                </a>
                <!-- Duplicate button -->
                <a class="btn btn-link duplicate-history-query px-1 py-0" routerLink="create" [queryParams]="{ duplicate: query.id }">
                  <span class="fa fa-copy"></span>
                </a>
                <!-- Delete button -->
                <button type="button" class="btn btn-link delete-history-query px-1 py-0" (click)="delete(query)">
                  <span class="fa fa-trash"></span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #empty>
      <div class="oib-grey-container empty" translate="history-query.none"></div>
    </ng-template>
  </ng-container>
</div>
