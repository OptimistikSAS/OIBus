import SerializationSettings from './_south-serialization-settings.mdx';

## Item Settings

Each item in the South connector can be individually configured with specific query parameters and datetime handling. Multiple queries to the same database can be executed sequentially within a single connector, with results consolidated into output files for North connectors.

### Query Configuration

The query field accepts standard SQL syntax with support for internal variables that enhance data retrieval resilience and performance optimization.

#### Query Variables

| Variable     | Description                                                                                         | Behavior                                       |
| ------------ | --------------------------------------------------------------------------------------------------- | ---------------------------------------------- |
| `@StartTime` | Initialized to first execution time, then updated to the most recent timestamp from reference field | Automatically advances based on retrieved data |
| `@EndTime`   | Set to current time (`now()`) or sub-interval end when queries are split                            | Defines upper bound for data retrieval         |

Example Query:

```sql
SELECT device_id, value, reading_time
FROM sensor_data
WHERE reading_time > @StartTime
AND reading_time < @EndTime
ORDER BY reading_time
```

:::info Query Splitting
For handling large datasets, queries can be automatically divided into smaller time-based chunks.
See [Splitting Large Queries](#throttling-settings) for configuration details.
:::

### Datetime Field Configuration

| Setting         | Description                                                               | Applies To                         | Example Value               |
| --------------- | ------------------------------------------------------------------------- | ---------------------------------- | --------------------------- |
| Field name      | Name of the datetime field in your SELECT statement                       | All types                          | `timestamp`, `reading_time` |
| Reference field | Designates which field determines the `@StartTime` for subsequent queries | All types                          | `reading_time`              |
| Type            | Data type of the datetime field in database                               | All fields                         | String, Date, DateTime      |
| Timezone        | Timezone of the stored datetime (required for string/date types)          | String/Date/DateTime/SmallDateTime | `UTC`, `Europe/Paris`       |
| Format          | Format pattern for string-based datetimes                                 | String type only                   | `yyyy-MM-dd HH:mm:ss`       |
| Locale          | Locale for format elements (e.g., month names)                            | String type only                   | `en_US`, `fr_FR`            |

:::warning Type Consistency Requirement
When using datetime conversions in queries:

Problematic approach (may cause unexpected behavior):

```sql
SELECT value, CONVERT(datetime, string_field) AS timestamp
FROM table
WHERE string_field > @StartTime
```

Recommended approach (maintains type consistency):

```sql
SELECT value, CONVERT(datetime, string_field) AS timestamp
FROM table
WHERE CONVERT(datetime, string_field) > @StartTime
```

:::

### Data Flow Process

1. OIBus executes each configured query sequentially
2. Results are consolidated into structured output
3. Max Instant is retrieved from the datetime field used as reference, converted to UTC format and stored to be used as the next `@StartTime`
4. Final output is formatted according to [serialization settings](#csv-serialization)
5. Processed data is sent to configured North connectors

:::tip Best Practices

1. Choose reference fields with consistent, increasing values
2. For string datetimes, ensure format matches between database storage and query variables
3. Add indexes on datetime fields for better performance
4. Use query splitting for large time ranges

:::

<SerializationSettings></SerializationSettings>
